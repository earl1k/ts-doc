# Контроллер DMA

Контроллер DMA позволяет передавать данные между такими устройствами компьютера как RAM, IDE, SPI, CRAM и SFILE минуя процессор. Во время передачи данных процессор может быть занят чем-то другим. В один момент времени может быть запущена лишь одна DMA транзакция.

Для управления DMA предусмотрены следующие регистры:

Регистр  |Назначение
---------|-----------------------------
DMASAddr*| Адрес источника данных в RAM
DMADAddr*| Адрес приемника данных в RAM
DMALen   | Длина блока
DMANum   | Количество блоков
DMACtrl  | Регистр управления DMA
DMAStatus| Состояние контроллера DMA

DMA транзакция производит передачу данных блоками. Единицей данных в блоках является машинный WORD, т.е. 16 бит. В регистрах DMA контроллера можно установить как размер самого блока (регистр **DMALen**), так и количество блоков (регистр **DMANum**) для обработки. Дополнительно в регистре **DMACtrl** можно задать выравнивание для каждого блока транзакции.

Значения в регистрах **DMALen** и **DMANum** должны быть на единицу меньше, т.к. они находятся в диапазоне 1 - 256.

##### Регистр DMACtrl

	Биты  7   6   5      4     3    2  1  0
	     W/R  - S_ALGN D_ALGN A_SZ DDEV[2:0]
	R/W   W       W      W     W    W  W  W
	Init  x   x   x      x     x    x  x  x

* Бит 7 - направление передачи данных: 0 - в память, 1 - из памяти,
* Бит 6 - зарезервировано,
* Бит 5 - включение выравнивания адреса источника (0 - отключено, 1 - включено),
* Бит 4 - включение выравнивания адреса приемника (0 - отключено, 1 - включено),
* Бит 3 - размер выравнивания: 0 - 256 байт, 1 - 512 байт,
* Биты 2:0 - выбор устройства для обмена данными.

Если включено выравнивания адреса источника или приемника, то после обработки каждого блока к предыдущему значению этого регистра прибавляется 256 или 512 байт в зависимости от бита *A_SZ*. Если выравнивание для адреса отключено, то значение регистра не изменяется и соответствует тому, что было в нем на момент окончания обработки последнего блока.

Адреса источника и приемника данных (*DMASAddr* и *DMADAddr*) являются 22 битными и для записи в них значений используются по 3 регистра: **DMASAddrL**, **DMASAddrH** и **DMASAddrX** - для адреса источника данных, **DMADAddrL**, **DMADAddrH**, **DMADAddrX** - для адреса приемника данных.

Для удобства адресации регистры **DMASAddrL** и **DMASAddrH** задают смещение внутри страницы памяти, а регистр **DMASAddrX** задает номер страницы. Для адреса приемника все аналогично.

Таблица выбора устройств:

Бит W/R|DDEV[2:0]|Источник|Приемник|Описание
:-----:|:-------:|:------:|:------:|----------------
   0   |   000   |   -    |   -    | Зарезервировано
   1   |   000   |   -    |   -    | Зарезервировано
   0   |   001   |  RAM   |  RAM   | Копирование RAM
   1   |   001   |  BLT   |  RAM   | Блиттинг RAM
   0   |   010   |  SPI   |  RAM   | Копирование из SPI в RAM
   1   |   010   |  RAM   |  SPI   | Копирование из RAM в SPI
   0   |   011   |  IDE   |  RAM   | Копирование из IDE в RAM
   1   |   011   |  RAM   |  IDE   | Копирование из RAM в IDE
   0   |   100   |  FILL  |  RAM   | Заполнение RAM
   1   |   100   |  RAM   |  CRAM  | Копирование из RAM в CRAM
   0   |   101   |   -    |   -    | Зарезервировано
   1   |   101   |  RAM   |  SFILE | Копирование из RAM в SFILE
   0   |   110   |   -    |   -    | Зарезервировано
   1   |   110   |   -    |   -    | Зарезервировано
   0   |   111   |   -    |   -    | Зарезервировано
   1   |   111   |   -    |   -    | Зарезервировано

**Блиттинг RAM**

Данные читаются из источника и приемника. Если значение в приемника не равно 0, то данные из источника записываются туда.

**Заполнение RAM**

Читается один WORD из источника и это значение используется для заполнения приемника.

##### Регистр DMAStatus

	Биты    7    6  5  4  3  2  1  0
         DMA_ACT -  -  -  -  -  -  -
	R/W     R
	Init    x    x  x  x  x  x  x  x

* Бит 7 - состояние DMA транзакции (0 - не активна, 1 - активна),
* Биты 6:0 - зарезервированы.

Состояние DMA транзакции можно определить по биту *DMA_ACT* регистра **DMAStatus**. По окончанию транзакции генерируется соответствующее прерывание, если оно было разрешено. Подробнее об этом можно узнать в разделе [Контроллер прерываний][interrupts].

[interrupts]: interrupts.md
